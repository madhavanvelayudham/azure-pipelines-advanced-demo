# ================= RESOURCES =================
resources:
  repositories:
    - repository: MYRavenRepo
      type: git
      name: Azure Pipeline Demo
      ref: main

# ================= TRIGGER =================
trigger:
- main

# ================= AGENT =================
pool:
  vmImage: 'ubuntu-latest'

# ================= STAGES =================
stages:

# ================= BUILD STAGE =================
- stage: Build
  displayName: 'Build Stage'
  jobs:
  - job: BuildJob
    displayName: 'Build Job'
    steps:
    - checkout: MYRavenRepo

    - task: Maven@3
      displayName: 'Maven Build'
      inputs:
        mavenPomFile: 'pom.xml'
        goals: 'clean package'
        jdkVersionOption: '1.11'

    # Publish build artifacts
    - publish: target
      artifact: drop


# ================= TEST STAGE =================
- stage: Test
  displayName: 'Test Stage'
  dependsOn: Build
  jobs:
  - job: TestJob
    displayName: 'Test Job'
    steps:
    - checkout: MYRavenRepo

    - task: Maven@3
      displayName: 'Run Regression Tests'
      inputs:
        mavenPomFile: 'pom.xml'
        goals: 'test'

    - task: PublishTestResults@2
      displayName: 'Publish Test Results'
      inputs:
        testResultsFiles: '**/surefire-reports/TEST-*.xml'
        testRunTitle: 'Maven Test Results'


# ================= DEPLOY TO STAGING =================
- stage: Deploy_Staging
  displayName: 'Deploy to Staging'
  dependsOn: Test
  condition: succeeded()
  jobs:
  - deployment: StagingDeploy
    displayName: 'Staging Deployment'
    environment: staging
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop

          - script: |
              echo "===================================="
              echo "Deploying application to STAGING"
              echo "Artifact location:"
              ls $(Pipeline.Workspace)/drop
              echo "STAGING deployment completed"
              echo "===================================="
            displayName: 'Staging Deployment Script'


# ================= DEPLOY TO PRODUCTION =================
- stage: Deploy_Production
  displayName: 'Deploy to Production'
  dependsOn: Deploy_Staging
  condition: succeeded()
  jobs:
  - deployment: ProductionDeploy
    displayName: 'Production Deployment'
    environment: production
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop

          - script: |
              echo "===================================="
              echo "Deploying application to PRODUCTION"
              echo "Artifact location:"
              ls $(Pipeline.Workspace)/drop
              echo "PRODUCTION deployment completed"
              echo "===================================="
            displayName: 'Production Deployment Script'
